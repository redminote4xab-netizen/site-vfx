<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delta Loteamento | Premium</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root { --gold: #c5a059; --dark: #0a0a0a; }
        body { background: var(--dark); font-family: 'Montserrat', sans-serif; color: white; overflow: hidden; margin: 0; }
        #map { height: 100vh; width: 100%; z-index: 1; background: #000; }
        
        #loader { position: fixed; inset: 0; background: #000; z-index: 9999; }

        .leaflet-marker-icon { background: none !important; border: none !important; pointer-events: none !important; }
        
        .lote-label-style {
            color: white !important; font-weight: 800; font-size: 14px !important;
            text-shadow: 2px 2px 4px #000; white-space: nowrap;
            display: flex; align-items: center; justify-content: center;
            width: 100px !important; margin-left: -50px !important;
        }
        
        .medida-label-style {
            color: #ffff00 !important; font-weight: 700; font-size: 11px !important;
            text-shadow: 1px 1px 2px #000; white-space: nowrap;
            display: flex; align-items: center; justify-content: center;
            width: 80px !important; margin-left: -40px !important;
        }

        .side-menu {
            position: absolute; left: 0; top: 0; bottom: 0; width: 380px;
            background: linear-gradient(to right, rgba(10,10,10,0.98) 60%, rgba(10,10,10,0));
            z-index: 2000; padding: 40px; pointer-events: none;
        }
        .side-menu > * { pointer-events: auto; }

        /* LOGO NO CANTO DIREITO */
        .logo-container {
            position: absolute; right: 40px; top: 40px;
            z-index: 2000; text-align: right; pointer-events: none;
        }

        .select-loteamento {
            background: rgba(0,0,0,0.7); border: 1px solid var(--gold);
            color: white; padding: 5px 10px; font-size: 10px;
            text-transform: uppercase; letter-spacing: 1px; outline: none;
            cursor: pointer; pointer-events: auto;
        }

        .btn-gold { background: var(--gold); color: #000; font-weight: 800; clip-path: polygon(5% 0, 100% 0, 95% 100%, 0% 100%); }
        .leaflet-routing-container { display: none !important; }

        #modal-reserva {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            z-index: 3000; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

    <div id="loader"></div>

    <div id="modal-reserva">
        <div class="bg-[#111] border border-[#c5a059] p-8 rounded-lg max-w-md w-full mx-4">
            <h3 class="cinzel text-2xl text-[#c5a059] mb-4">Como podemos ajudar?</h3>
            <div class="flex flex-col gap-3">
                <button onclick="enviarWhats('Gostaria de fazer uma visita')" class="text-left p-4 bg-white/5 hover:bg-[#c5a059] hover:text-black transition-all rounded text-sm font-semibold">üìç Gostaria de fazer uma visita</button>
                <button onclick="enviarWhats('Gostaria de comprar com urg√™ncia')" class="text-left p-4 bg-white/5 hover:bg-[#c5a059] hover:text-black transition-all rounded text-sm font-semibold">üî• Gostaria de comprar com urg√™ncia</button>
                <button onclick="enviarWhats('Estou interessado(a) e gostaria de mais informa√ß√µes')" class="text-left p-4 bg-white/5 hover:bg-[#c5a059] hover:text-black transition-all rounded text-sm font-semibold">‚ÑπÔ∏è Gostaria de mais informa√ß√µes</button>
                <button onclick="fecharModal()" class="mt-4 text-center text-[10px] text-gray-500 underline uppercase">Cancelar</button>
            </div>
        </div>
    </div>

    <nav class="side-menu flex flex-col justify-between">
        <div>
            <div class="mb-8">
                <select id="select-folder" class="select-loteamento mb-4" onchange="carregarLoteamento(this.value)">
                    <option value="LOTEAMENTO 1">LOTEAMENTO 1</option>
                    <option value="LOTEAMENTO 2">LOTEAMENTO 2</option>
                </select>
                <h2 id="display-nome" class="cinzel text-4xl text-[#c5a059]">DELTA</h2>
                <p class="text-[10px] tracking-[6px] text-gray-500 uppercase">Premium Loteamento</p>
            </div>
            
            <div id="container-distancia" class="opacity-0 bg-red-900/20 border border-red-600 p-4 rounded-lg mb-4">
                <h3 id="distancia-km" class="text-2xl font-bold text-white">0.0 km</h3>
                <p id="tempo-viagem" class="text-sm text-red-500 font-semibold">-- min</p>
                <button onclick="cancelarRota()" class="mt-2 text-[9px] text-white bg-red-600 px-2 py-1 rounded font-bold">LIMPAR ROTA</button>
            </div>
        </div>

        <div id="lote-card" class="opacity-0 translate-y-10 bg-black/95 p-7 border-l-2 border-[#0088ff] shadow-2xl">
            <div id="badge-promo" class="hidden bg-red-600 text-white text-[10px] font-bold px-2 py-1 mb-4 inline-block rounded">PROMO√á√ÉO DISPON√çVEL</div>
            <h2 id="lote-title" class="text-4xl cinzel mb-2 text-white">Lote --</h2>
            <p id="lote-obs" class="text-[11px] text-[#c5a059] italic mb-6"></p>
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-white/5 p-3">
                    <p class="text-[9px] text-gray-500 uppercase">√Årea Total</p>
                    <p class="text-xl font-bold text-white" id="lote-area">--</p>
                </div>
                <div class="bg-white/5 p-3">
                    <p class="text-[9px] text-gray-500 uppercase">Per√≠metro</p>
                    <p class="text-xl font-bold text-white" id="lote-perimetro">--</p>
                </div>
            </div>
            <button id="btn-reserva" onclick="abrirModal()" class="btn-gold py-4 w-full uppercase tracking-widest text-xs">Reservar Agora</button>
        </div>
    </nav>

    <div class="logo-container">
        <img id="loteamento-logo" src="logo.png" alt="LOGO" class="w-32 ml-auto mb-2">
    </div>

    <div id="map"></div>

    <script>
        let loteSelecionadoGlobal = "";
        let pastaAtual = "LOTEAMENTO 1";

        window.addEventListener('load', () => {
            gsap.to("#loader", { opacity: 0, duration: 1, onComplete: () => {
                document.getElementById('loader').remove();
                carregarLoteamento(pastaAtual);
            }});
        });

        const map = L.map('map', { zoomControl: false, maxZoom: 22 }).setView([-2.4438, -54.7085], 18);
        L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', { maxZoom: 22 }).addTo(map);

        let camadaLotes, controleRota, marcadorDestino;
        let pontoOrigem = null;
        let camadaTextos = L.layerGroup().addTo(map);

        function carregarLoteamento(pasta) {
            pastaAtual = pasta;
            if(camadaLotes) map.removeLayer(camadaLotes);
            camadaTextos.clearLayers();
            cancelarRota();
            gsap.to("#lote-card", { opacity: 0, y: 10 });

            document.getElementById('loteamento-logo').src = `${pasta}/LOGO.png`;
            document.getElementById('display-nome').innerText = pasta.replace("LOTEAMENTO", "DELTA");

            // Fetch Medidas com Anti-Cache
            fetch(`${pasta}/MEDIDAS.geojson?t=${Date.now()}`).then(res => res.json()).then(data => {
                L.geoJSON(data, {
                    onEachFeature: (f, layer) => {
                        const d = f.properties.Dist√¢ncia || f.properties.distancia;
                        if(d && f.geometry.type === 'LineString') {
                            const angle = getRotation(f.geometry.coordinates);
                            L.marker(layer.getBounds().getCenter(), {
                                icon: L.divIcon({ 
                                    className: 'medida-label-style', 
                                    html: `<div style="transform: rotate(${angle}deg);">${parseFloat(d).toFixed(1)}m</div>`
                                }),
                                interactive: false
                            }).addTo(camadaTextos);
                        }
                    }
                });
            }).catch(err => console.log("Sem arquivo de medidas"));

            // Fetch Lotes com Anti-Cache (Garante leitura da atualiza√ß√£o do Python)
            fetch(`${pasta}/LOTES.geojson?t=${Date.now()}`).then(res => res.json()).then(data => {
                camadaLotes = L.geoJSON(data, {
                    style: definirEstilo,
                    onEachFeature: (f, layer) => {
                        const idLote = f.properties.Lote || f.properties.id || f.properties.fid || "";
                        if(idLote) {
                            L.marker(layer.getBounds().getCenter(), {
                                icon: L.divIcon({ className: 'lote-label-style', html: `Lote ${idLote}` }),
                                interactive: false
                            }).addTo(camadaTextos);
                        }

                        layer.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            camadaLotes.eachLayer(l => camadaLotes.resetStyle(l));
                            pontoOrigem = e.latlng;
                            loteSelecionadoGlobal = idLote;
                            layer.setStyle({ color: '#fff', weight: 4, fillOpacity: 0.9, fillColor: '#0088ff' });
                            
                            document.getElementById('lote-title').innerText = "Lote " + idLote;
                            document.getElementById('lote-area').innerText = (f.properties.area_m2 || f.properties.Area || "0.00") + " m¬≤";
                            document.getElementById('lote-perimetro').innerText = (f.properties.perimetroM || "--") + " m";
                            
                            const obs = f.properties.obs || "";
                            const elObs = document.getElementById('lote-obs');
                            const elBadge = document.getElementById('badge-promo');
                            
                            if(obs.trim() !== "") {
                                elObs.innerText = "‚≠ê " + obs;
                                elBadge.classList.remove('hidden');
                            } else {
                                elObs.innerText = "";
                                elBadge.classList.add('hidden');
                            }

                            const statusLote = f.properties.status || 'disponivel';
                            const btnReserva = document.getElementById('btn-reserva');
                            if(statusLote === 'vendido') {
                                btnReserva.innerText = "LOTE VENDIDO";
                                btnReserva.style.pointerEvents = "none";
                                btnReserva.style.background = "#333";
                            } else {
                                btnReserva.innerText = "RESERVAR AGORA";
                                btnReserva.style.pointerEvents = "auto";
                                btnReserva.style.background = "#c5a059";
                            }
                            gsap.to("#lote-card", { opacity: 1, y: 0, duration: 0.5 });
                        });
                    }
                }).addTo(map);
                map.fitBounds(camadaLotes.getBounds());
            });
        }

        function definirEstilo(feature) {
            const status = feature.properties.status || 'disponivel';
            if (status === 'vendido') return { fillColor: '#ff0000', weight: 1.5, color: 'white', fillOpacity: 0.7 };
            if (status === 'reservado') return { fillColor: '#0088ff', weight: 1.5, color: 'white', fillOpacity: 0.7 };
            return { fillColor: '#2ecc71', weight: 1.5, color: 'white', fillOpacity: 0.4 };
        }

        function getRotation(coords) {
            const p1 = map.project(L.latLng(coords[0][1], coords[0][0]));
            const p2 = map.project(L.latLng(coords[1][1], coords[1][0]));
            let angle = Math.atan2(p2.y - p1.y, p2.x - p1.x) * 180 / Math.PI;
            if (angle > 90) angle -= 180;
            if (angle < -90) angle += 180;
            return angle;
        }

        function abrirModal() { document.getElementById('modal-reserva').style.display = 'flex'; }
        function fecharModal() { document.getElementById('modal-reserva').style.display = 'none'; }

        function enviarWhats(opcao) {
            const tel = "5593984236665";
            const msg = encodeURIComponent(`Ol√°! Estou no site.\nLoteamento: *${pastaAtual}*\nLote: *${loteSelecionadoGlobal}*\n\nMotivo: *${opcao}*`);
            window.open(`https://wa.me/${tel}?text=${msg}`, '_blank');
            fecharModal();
        }

        map.on('click', function(e) {
            if(!pontoOrigem) return;
            if (marcadorDestino) marcadorDestino.setLatLng(e.latlng);
            else {
                marcadorDestino = L.marker(e.latlng, {
                    icon: L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [30, 30], iconAnchor: [15, 30] })
                }).addTo(map);
            }
            if(controleRota) map.removeControl(controleRota);
            controleRota = L.Routing.control({
                waypoints: [pontoOrigem, e.latlng],
                lineOptions: { styles: [{ color: 'red', weight: 6, opacity: 0.9 }] },
                createMarker: () => null
            }).on('routesfound', function(ev) {
                const r = ev.routes[0];
                document.getElementById('distancia-km').innerText = (r.summary.totalDistance / 1000).toFixed(1) + " km";
                document.getElementById('tempo-viagem').innerText = Math.round(r.summary.totalTime / 60) + " min";
                gsap.to("#container-distancia", { opacity: 1, duration: 0.5 });
            }).addTo(map);
        });

        function cancelarRota() {
            if(controleRota) map.removeControl(controleRota);
            if(marcadorDestino) map.removeLayer(marcadorDestino);
            marcadorDestino = null;
            gsap.to("#container-distancia", { opacity: 0, duration: 0.3 });
        }
    </script>
</body>
</html>